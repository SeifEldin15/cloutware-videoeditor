name: Deploy to Server

# Trigger the workflow on push to main branch
on:
  push:
    branches: [ main ]
  workflow_dispatch:  # Allow manual trigger

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Check SSH Secrets
      run: |
        if [ -z "${{ secrets.SSH_USERNAME }}" ] || [ -z "${{ secrets.SSH_PRIVATE_KEY }}" ]; then
          echo "❌ SSH secrets are not configured!"
          echo ""
          echo "Please add these secrets to your GitHub repository:"
          echo "1. Go to Settings → Secrets and variables → Actions"
          echo "2. Add these secrets:"
          echo "   - SSH_USERNAME: Your server username (e.g., ubuntu)"
          echo "   - SSH_PRIVATE_KEY: Your SSH private key content"
          echo "   - SSH_PORT: 22 (optional)"
          echo ""
          echo "📚 See SIMPLE-CI-CD-GUIDE.md for detailed instructions"
          exit 1
        fi
        echo "✅ SSH secrets are configured"
      
    - name: Deploy to Server
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: 18.144.88.135
        username: ${{ secrets.SSH_USERNAME }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: ${{ secrets.SSH_PORT || '22' }}
        timeout: 120s
        command_timeout: 15m
        script_stop: true
        script: |
          echo "🚀 Starting simple deployment..."
          
          # Check and clean up disk space first
          echo "💾 Checking disk space..."
          df -h $HOME
          
          # Clean up npm cache and temporary files
          echo "🧹 Cleaning up to free disk space..."
          npm cache clean --force || true
          rm -rf ~/.npm/_cacache || true
          rm -rf /tmp/npm-* || true
          sudo apt-get autoremove -y || true
          sudo apt-get autoclean || true
          
          # Navigate to home and clean up if exists
          cd $HOME
          rm -rf cloutware-videoeditor
          
          echo "💾 Disk space after cleanup:"
          df -h $HOME
          
          # Clone repository
          echo "📥 Cloning repository..."
          git clone https://github.com/SeifEldin15/cloutware-videoeditor.git
          cd cloutware-videoeditor
          
          # Install dependencies with optimizations
          echo "📦 Installing dependencies..."
          npm ci --only=production --no-audit --no-fund || npm install --only=production --no-audit --no-fund
          
          echo "🔨 Building application..."
          npm run build
          
          # Clean up after build to save space
          echo "🧹 Cleaning up after build..."
          npm cache clean --force || true
          rm -rf node_modules/.cache || true
          
          # Stop existing PM2 process
          echo "🛑 Stopping existing processes..."
          pm2 stop video-processing || true
          pm2 delete video-processing || true
          
          # Start application
          echo "🚀 Starting application..."
          pm2 start npm --name "video-processing" -- start
          
          # Show status
          echo "📊 PM2 Status:"
          pm2 status
          
          echo "✅ Deployment completed!"
          echo "🌐 Application running on http://18.144.88.135:3000"